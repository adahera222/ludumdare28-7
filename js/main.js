// Generated by CoffeeScript 1.6.3
var AfterDeathRestartGameTransitionState, AfterLevelCompletedTransitionState, Game, GameOverScreenState, GameStartTransitionState, GameState, InstructionsScreenState, PlayState, TitleScreenState, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

GameState = (function() {
  function GameState(cq, assetManager, args) {
    this.cq = cq;
    this.assetManager = assetManager;
    this.eventManager = new EventManager();
    this.entityManager = new EntityManager(window.components);
    this.create(args);
  }

  GameState.prototype.loadAssets = function() {};

  GameState.prototype.create = function(args) {};

  GameState.prototype.start = function() {};

  GameState.prototype.step = function(delta, time) {};

  GameState.prototype.render = function(delta, time) {};

  GameState.prototype.keyUp = function(key) {};

  GameState.prototype.keyDown = function(key) {};

  return GameState;

})();

TitleScreenState = (function(_super) {
  __extends(TitleScreenState, _super);

  function TitleScreenState() {
    _ref = TitleScreenState.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  TitleScreenState.prototype.create = function(args) {
    var background, camera;
    background = this.entityManager.createEntityWithComponents([
      [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ], [
        'StaticSpriteComponent', {
          spriteUrl: 'title-screen.png'
        }
      ]
    ]);
    camera = this.entityManager.createEntityWithComponents([
      ['CameraComponent', {}], [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ]
    ]);
    this.staticSpriteRenderSystem = new StaticSpriteRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    window.soundManager.stopAll();
    return window.soundManager.play('title-screen-music.ogg');
  };

  TitleScreenState.prototype.render = function(delta, time) {
    return this.staticSpriteRenderSystem.draw();
  };

  TitleScreenState.prototype.keyUp = function(key) {
    if (key === 'space') {
      return game.pushState(InstructionsScreenState, {
        prevScreen: this.cq.getImageData(0, 0, Game.SCREEN_WIDTH, Game.SCREEN_HEIGHT)
      });
    }
  };

  return TitleScreenState;

})(GameState);

InstructionsScreenState = (function(_super) {
  __extends(InstructionsScreenState, _super);

  function InstructionsScreenState() {
    _ref1 = InstructionsScreenState.__super__.constructor.apply(this, arguments);
    return _ref1;
  }

  InstructionsScreenState.prototype.create = function(args) {
    var background, camera;
    background = this.entityManager.createEntityWithComponents([
      [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ], [
        'StaticSpriteComponent', {
          spriteUrl: 'instructions-screen.png'
        }
      ]
    ]);
    camera = this.entityManager.createEntityWithComponents([
      ['CameraComponent', {}], [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ]
    ]);
    return this.staticSpriteRenderSystem = new StaticSpriteRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
  };

  InstructionsScreenState.prototype.render = function(delta, time) {
    return this.staticSpriteRenderSystem.draw();
  };

  InstructionsScreenState.prototype.keyUp = function(key) {
    if (key === 'space') {
      window.soundManager.stopAll();
      return game.pushState(GameStartTransitionState, {
        prevScreen: this.cq.getImageData(0, 0, Game.SCREEN_WIDTH, Game.SCREEN_HEIGHT)
      });
    }
  };

  return InstructionsScreenState;

})(GameState);

GameStartTransitionState = (function(_super) {
  __extends(GameStartTransitionState, _super);

  function GameStartTransitionState() {
    _ref2 = GameStartTransitionState.__super__.constructor.apply(this, arguments);
    return _ref2;
  }

  GameStartTransitionState.prototype.create = function(args) {
    this.prevScreen = args.prevScreen;
    return this.wipeX = 0;
  };

  GameStartTransitionState.prototype.step = function(delta, time) {
    this.wipeX += delta;
    if (this.wipeX > Game.SCREEN_WIDTH) {
      return game.pushState(PlayState, {});
    }
  };

  GameStartTransitionState.prototype.render = function(delta, time) {
    this.cq.putImageData(this.prevScreen, 0, 0);
    this.cq.fillStyle('black');
    return this.cq.fillRect(0, 0, this.wipeX, Game.SCREEN_HEIGHT);
  };

  return GameStartTransitionState;

})(GameState);

AfterDeathRestartGameTransitionState = (function(_super) {
  __extends(AfterDeathRestartGameTransitionState, _super);

  function AfterDeathRestartGameTransitionState() {
    _ref3 = AfterDeathRestartGameTransitionState.__super__.constructor.apply(this, arguments);
    return _ref3;
  }

  AfterDeathRestartGameTransitionState.prototype.create = function(args) {
    this.args = args;
    this.wipe = 0;
    this.delay = 2400;
    if (this.args.next === 'next-life') {
      return window.soundManager.play('died-sadsound.wav');
    } else {
      return window.soundManager.play('died-sadsound.wav');
    }
  };

  AfterDeathRestartGameTransitionState.prototype.step = function(delta, time) {
    if (this.wipe > Game.SCREEN_WIDTH / 2) {
      this.delay -= delta;
      if (this.delay <= 0) {
        if (this.args.next === 'next-life') {
          window.soundManager.play('title-screen-music.ogg', {
            volume: 40
          });
          return game.popState();
        } else if (this.args.next === 'game-over') {
          return game.pushState(GameOverScreenState, {
            finalScore: this.args.finalScore
          });
        } else {
          throw "Exception!";
        }
      }
    } else {
      return this.wipe += delta * 0.7;
    }
  };

  AfterDeathRestartGameTransitionState.prototype.render = function(delta, time) {
    this.cq.putImageData(this.args.prevScreen, 0, 0);
    this.cq.fillStyle('red');
    this.cq.fillRect(0, 0, Game.SCREEN_WIDTH, this.wipe);
    this.cq.fillRect(0, Game.SCREEN_HEIGHT - this.wipe, Game.SCREEN_WIDTH, this.wipe);
    if (this.wipe >= Game.SCREEN_WIDTH / 2) {
      this.cq.font('102px "Merienda One"').textAlign('center').fillStyle('black');
      return this.cq.fillText('DEAD  :(', Game.SCREEN_WIDTH / 2, Game.SCREEN_HEIGHT / 2);
    }
  };

  return AfterDeathRestartGameTransitionState;

})(GameState);

AfterLevelCompletedTransitionState = (function(_super) {
  __extends(AfterLevelCompletedTransitionState, _super);

  function AfterLevelCompletedTransitionState() {
    _ref4 = AfterLevelCompletedTransitionState.__super__.constructor.apply(this, arguments);
    return _ref4;
  }

  AfterLevelCompletedTransitionState.prototype.create = function(args) {
    this.prevScreen = args.prevScreen;
    this.wipe = 0;
    this.delay = 1000;
    return window.soundManager.play('yay.wav');
  };

  AfterLevelCompletedTransitionState.prototype.step = function(delta, time) {
    if (this.wipe > Game.SCREEN_WIDTH / 2) {
      this.delay -= delta;
      if (this.delay <= 0) {
        return game.popState();
      }
    } else {
      return this.wipe += delta * 0.7;
    }
  };

  AfterLevelCompletedTransitionState.prototype.render = function(delta, time) {
    this.cq.putImageData(this.prevScreen, 0, 0);
    this.cq.fillStyle('green');
    this.cq.fillRect(0, 0, Game.SCREEN_WIDTH, this.wipe);
    this.cq.fillRect(0, Game.SCREEN_HEIGHT - this.wipe, Game.SCREEN_WIDTH, this.wipe);
    if (this.wipe >= Game.SCREEN_WIDTH / 2) {
      this.cq.font('102px "Merienda One"').textAlign('center').fillStyle('black');
      return this.cq.fillText('WIN  :D', Game.SCREEN_WIDTH / 2, Game.SCREEN_HEIGHT / 2);
    }
  };

  return AfterLevelCompletedTransitionState;

})(GameState);

PlayState = (function(_super) {
  __extends(PlayState, _super);

  function PlayState() {
    _ref5 = PlayState.__super__.constructor.apply(this, arguments);
    return _ref5;
  }

  PlayState.prototype.create = function(args) {
    var camera, col, player, row, scoreEntity;
    col = 5;
    row = 5;
    player = this.entityManager.createEntityWithComponents([
      ['PlayerComponent', {}], [
        'GridPositionComponent', {
          col: col,
          row: row,
          gridSize: Game.GRID_SIZE
        }
      ], ['PowerupComponent', {}], [
        'PixelPositionComponent', {
          x: col * Game.GRID_SIZE,
          y: row * Game.GRID_SIZE
        }
      ], [
        'DirectionComponent', {
          direction: 'right'
        }
      ], ['ActionInputComponent', {}], ['KeyboardArrowsInputComponent', {}], [
        'ColorComponent', {
          color: 'red'
        }
      ], [
        'GridMovementComponent', {
          speed: 0.4
        }
      ], ['CollidableComponent', {}], [
        'AnimationComponent', {
          currentAction: 'idle-right',
          spritesheetUrl: 'squirrel.png',
          frameWidth: 112,
          frameHeight: 112,
          offsetX: 24,
          offsetY: 48
        }
      ], [
        'AnimationActionComponent', {
          name: 'idle-right',
          row: 0,
          indices: [0],
          frameLength: 100
        }
      ], [
        'AnimationActionComponent', {
          name: 'idle-left',
          row: 1,
          indices: [0],
          frameLength: 100
        }
      ], [
        'AnimationActionComponent', {
          name: 'idle-down',
          row: 2,
          indices: [0],
          frameLength: 100
        }
      ], [
        'AnimationActionComponent', {
          name: 'idle-up',
          row: 3,
          indices: [0],
          frameLength: 100
        }
      ], [
        'AnimationActionComponent', {
          name: 'walk-right',
          row: 0,
          indices: [0, 1, 2],
          frameLength: 50
        }
      ], [
        'AnimationActionComponent', {
          name: 'walk-left',
          row: 1,
          indices: [0, 1, 2],
          frameLength: 50
        }
      ], [
        'AnimationActionComponent', {
          name: 'walk-down',
          row: 2,
          indices: [0, 1, 2],
          frameLength: 50
        }
      ], [
        'AnimationActionComponent', {
          name: 'walk-up',
          row: 3,
          indices: [0, 1, 2],
          frameLength: 50
        }
      ], ['CameraFollowsComponent', {}]
    ]);
    camera = this.entityManager.createEntityWithComponents([
      ['CameraComponent', {}], [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ]
    ]);
    scoreEntity = this.entityManager.createEntityWithComponents([
      [
        'ScoreComponent', {
          score: 0
        }
      ], [
        'LivesComponent', {
          lives: 3
        }
      ], [
        'CurrentLevelComponent', {
          level: 0
        }
      ]
    ]);
    this.gridMovementSystem = new GridMovementSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.tweenSystem = new TweenSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.shapeRenderSystem = new ShapeRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.inputSystem = new InputSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.cameraFollowingSystem = new CameraFollowingSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.randomInputSystem = new RandomInputSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.tilemapRenderingSystem = new TilemapRenderingSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.animationDirectionSyncSystem = new AnimationDirectionSyncSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.animatedSpriteSystem = new AnimatedSpriteSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.staticSpriteRenderSystem = new StaticSpriteRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.eyeFollowingSystem = new EyeFollowingSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.acornSystem = new AcornSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.astarInputSystem = new AstarInputSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.scoreRenderingSystem = new ScoreRenderingSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.enemyDamageSystem = new EnemyDamageSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.levelLoaderSystem = new LevelLoaderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.fireSpreadingSystem = new FireSpreadingSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.multiStateStaticSpriteRenderSystem = new MultiStateStaticSpriteRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    this.powerupSystem = new PowerupSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    return this.eventManager.trigger('next-level', player);
  };

  PlayState.prototype.step = function(delta, time) {
    this.eventManager.pump();
    this.fireSpreadingSystem.update(delta, time);
    this.astarInputSystem.update(delta, time);
    this.gridMovementSystem.update(delta, time);
    this.tweenSystem.update(delta, time);
    this.randomInputSystem.update(delta, time);
    this.acornSystem.update(delta, time);
    this.animatedSpriteSystem.update(delta, time);
    this.animationDirectionSyncSystem.update(delta, time);
    this.cameraFollowingSystem.update(delta, time);
    this.enemyDamageSystem.update(delta, time);
    return this.powerupSystem.update(delta, time);
  };

  PlayState.prototype.render = function(delta, time) {
    this.cq.clear('white');
    this.tilemapRenderingSystem.draw();
    this.shapeRenderSystem.draw();
    this.staticSpriteRenderSystem.draw();
    this.multiStateStaticSpriteRenderSystem.draw();
    this.eyeFollowingSystem.draw();
    this.animatedSpriteSystem.draw();
    this.scoreRenderingSystem.draw();
    return this.powerupSystem.draw();
  };

  PlayState.prototype.keyUp = function(key) {
    return this.inputSystem.updateKey(key, false);
  };

  PlayState.prototype.keyDown = function(key) {
    this.inputSystem.updateKey(key, true);
    return this.powerupSystem.activate(key);
  };

  return PlayState;

})(GameState);

GameOverScreenState = (function(_super) {
  __extends(GameOverScreenState, _super);

  function GameOverScreenState() {
    _ref6 = GameOverScreenState.__super__.constructor.apply(this, arguments);
    return _ref6;
  }

  GameOverScreenState.prototype.create = function(args) {
    var background, camera;
    background = this.entityManager.createEntityWithComponents([
      [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ], [
        'StaticSpriteComponent', {
          spriteUrl: 'game-over-screen.png'
        }
      ]
    ]);
    camera = this.entityManager.createEntityWithComponents([
      ['CameraComponent', {}], [
        'PixelPositionComponent', {
          x: 0,
          y: 0
        }
      ]
    ]);
    this.score = args.finalScore;
    this.staticSpriteRenderSystem = new StaticSpriteRenderSystem(this.cq, this.entityManager, this.eventManager, this.assetManager);
    window.soundManager.stopAll();
    window.soundManager.play('game-over-voice.wav');
    return window.soundManager.play('game-over-music.ogg');
  };

  GameOverScreenState.prototype.render = function(delta, time) {
    this.cq.font('102px "Merienda One"').textAlign('center').fillStyle('black');
    this.staticSpriteRenderSystem.draw();
    return this.cq.fillText(this.score, Game.SCREEN_WIDTH / 2, 194);
  };

  GameOverScreenState.prototype.keyUp = function(key) {
    if (key === 'space') {
      window.soundManager.stopAll();
      game.popState();
      game.popState();
      return game.pushState(PlayState, {});
    }
  };

  return GameOverScreenState;

})(GameState);

Game = (function() {
  Game.SCREEN_WIDTH = 640;

  Game.SCREEN_HEIGHT = 640;

  Game.GRID_SIZE = 64;

  function Game() {
    var _this = this;
    soundManager.setup({
      url: 'js/lib/soundmanager/swf/soundmanager2.swf',
      flashVersion: 9,
      waitForWindowLoad: true,
      useHighPerformance: true,
      onready: function() {
        _this.cq = cq(Game.SCREEN_WIDTH, Game.SCREEN_HEIGHT).appendTo('body');
        _this.states = [];
        _this.currentState = null;
        _this.assetManager = new AssetManager();
        _this.assetManager.loadImage('tiles.png');
        _this.assetManager.loadImage('squirrel.png');
        _this.assetManager.loadImage('acorn.png');
        _this.assetManager.loadImage('acorn-eyes.png');
        _this.assetManager.loadImage('fire.png');
        _this.assetManager.loadImage('dog.png');
        _this.assetManager.loadImage('title-screen.png');
        _this.assetManager.loadImage('game-over-screen.png');
        _this.assetManager.loadImage('instructions-screen.png');
        _this.assetManager.loadTilemap('level1.json');
        _this.assetManager.loadTilemap('level2.json');
        _this.assetManager.loadTilemap('level3.json');
        _this.assetManager.loadSoundEffect('crunch.wav');
        _this.assetManager.loadSoundEffect('nom-nom-nom.wav');
        _this.assetManager.loadSoundEffect('dog-eat.wav');
        _this.assetManager.loadSoundEffect('fire.wav');
        _this.assetManager.loadSoundEffect('died-sadsound.wav');
        _this.assetManager.loadSoundEffect('yay.wav');
        _this.assetManager.loadSoundEffect('game-over-voice.wav');
        _this.assetManager.loadSoundEffect('powerup.wav');
        _this.assetManager.loadBGM('title-screen-music.ogg');
        _this.assetManager.loadBGM('game-over-music.ogg');
        return _this.assetManager.start(function() {
          _this.pushState(TitleScreenState);
          return _this.cq.framework({
            onstep: function(delta, time) {
              if (_this.currentState) {
                return _this.currentState.step(delta, time);
              }
            },
            onrender: function(delta, time) {
              if (_this.currentState) {
                return _this.currentState.render(delta, time);
              }
            },
            onkeydown: function(key) {
              if (_this.currentState) {
                return _this.currentState.keyDown(key);
              }
            },
            onkeyup: function(key) {
              if (_this.currentState) {
                return _this.currentState.keyUp(key);
              }
            }
          });
        });
      }
    });
  }

  Game.prototype.pushState = function(stateClass, args) {
    var state;
    state = new stateClass(this.cq, this.assetManager, args);
    this.states.push(state);
    this.currentState = state;
    return state.start(args);
  };

  Game.prototype.popState = function(args) {
    var prevState;
    if (this.states.length > 1) {
      this.states.pop();
      prevState = this.states[this.states.length - 1];
      this.currentState = prevState;
      return prevState.start(args);
    } else {
      throw "Can't pop last state!";
    }
  };

  return Game;

})();

window.game = new Game();
